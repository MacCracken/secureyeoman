# Architecture Overview

> Technical architecture and system design for F.R.I.D.A.Y. and SecureYeoman

## Table of Contents

1. [System Architecture](#system-architecture)
2. [Core Components](#core-components)
3. [Security Architecture](#security-architecture)
4. [Data Flow](#data-flow)
5. [Technology Stack](#technology-stack)
6. [Design Decisions](#design-decisions)

---

## System Architecture

### High-Level Architecture

```
┌─────────────────────────────────────────────────────────┐
│                   FRIDAY Dashboard                      │
│            (React + TanStack + ReactFlow)               │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌───────────┐  │
│  │ Overview │ │   Chat   │ │  Tasks   │ │  General  │ │
 │  │          │ │          │ │          │ │  Security │ │
 │  │          │ │          │ │          │ │API Keys   │ │
│  └──────────┘ └────┬─────┘ └──────────┘ └───────────┘  │
└─────────────────────┼─────────────────────────────────┘
                      │ WebSocket + REST
                      ▼
┌─────────────────────────────────────────────────────────┐
│                  SecureYeoman Gateway                   │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐        │
│  │   Security  │ │   Metrics   │ │    Audit    │        │
│  │    Layer    │ │  Collector  │ │    Chain    │        │
│  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘        │
│         └───────────────┼───────────────┘               │
│                         ▼                               │
│  ┌──────────┐ ┌──────────────────────────────────────┐  │
│  │   Chat   │ │         Sandboxed Agent Engine        │  │
│  │  Routes  │ │ (Anthropic, OpenAI, Gemini, Ollama, OpenCode) │  │
│  └────┬─────┘ └──────────────────────────────────────┘  │
│       │  ┌────────────┐ ┌───────────────┐                │
│       └──│ SoulManager│ │ Model Switch  │                │
│          └────────────┘ └───────────────┘                │
└─────────────────────────────────────────────────────────┘
```

### Monorepo Structure

```
friday/
├── README.md                   # Project overview
├── CONTRIBUTING.md             # Development guide
├── SECURITY.md                # Security policy
├── LICENSE                    # MIT License
├── packages/
│   ├── shared/                # Shared types and utilities
│   │   └── src/
│   │       └── types/         # TypeScript interfaces
│   ├── core/                  # Agent engine
│   │   └── src/
│   │       ├── ai/            # Multi-provider AI client, chat + model routes
│   │       ├── cli.ts         # CLI entry point
│   │       ├── config/        # Configuration management
│   │       ├── gateway/       # Fastify server + auth
│   │       ├── logging/       # Audit chain + storage
│   │       ├── sandbox/       # Cross-platform sandbox
│   │       ├── security/      # RBAC, auth, secrets
│   │       ├── brain/          # Memory, knowledge, skills
│   │       ├── comms/          # E2E encrypted agent comms
│   │       ├── soul/          # Personality + identity
│   │       ├── task/          # Task execution + storage
│   │       ├── integrations/  # Platform adapters (Telegram, Discord, Slack, GitHub)
│   │       └── utils/         # Crypto utilities
│   └── dashboard/             # React dashboard
│       └── src/
│           ├── components/    # UI components
│           ├── hooks/         # React hooks
│           └── api/           # API client
├── tests/                     # Security, load, and chaos tests
│   ├── security/              # Injection, JWT, RBAC, rate limit tests
│   ├── load/                  # k6 load test scripts
│   └── chaos/                 # Database corruption, crash recovery tests
├── deploy/                    # Deployment configurations
│   ├── grafana/               # Grafana dashboard JSON
│   ├── prometheus/            # Prometheus alert rules
│   └── logging/               # Loki, Promtail, docker-compose configs
├── scripts/                   # Utility scripts
├── docs/                      # Documentation
│   ├── api/                   # API documentation
│   ├── guides/                # User guides
│   ├── security/              # Security docs
│   └── development/           # Development docs
└── .github/                   # CI/CD workflows
```

---

## Core Components

### 1. Agent Engine (Core)

**Location**: `packages/core/src/`

**Responsibilities**:
- Task execution and lifecycle management
- Multi-provider AI integration
- Resource monitoring and metrics collection
- Audit logging and integrity verification

**Key Modules**:
- `ai/` - AI provider abstraction (Anthropic, OpenAI, Gemini, Ollama) with configurable fallback chain on rate limits / provider unavailability
- `task/` - Task queue, execution, and persistence
- `logging/` - Structured logging with cryptographic audit chain
- `config/` - Configuration loading and validation

### 2. Security Layer

**Location**: `packages/core/src/security/`

**Responsibilities**:
- Authentication and authorization (RBAC)
- Encryption and secret management
- Input validation and sanitization
- Rate limiting and threat detection

**Key Modules**:
- `rbac.ts` - Role-based access control
- `auth.ts` - JWT and API key authentication
- `secrets.ts` - Encrypted storage and keyring integration
- `rate-limiter.ts` - Sliding window rate limiting

### 3. Gateway Server

**Location**: `packages/core/src/gateway/`

**Responsibilities**:
- HTTP API endpoints
- WebSocket real-time updates
- Request routing and middleware
- Health checks and metrics export

**Features**:
- Fastify-based REST API
- WebSocket server for real-time updates
- Authentication middleware
- Request validation and rate limiting

### 4. Dashboard UI

**Location**: `packages/dashboard/src/`

**Responsibilities**:
- Real-time monitoring interface
- Task history and management
- Security event monitoring
- System configuration

**Key Components**:
- `DashboardLayout` - Responsive shell with adaptive header, nav, and footer
- `OverviewPage` - Stat cards (tasks, heartbeat, audit, memory), services status panel (core, Postgres, audit chain, MCP, uptime, version), and system flow graph
- `StatusBar` - Inline connection/WebSocket/reconnecting status indicators
- `NavigationTabs` - 9-tab nav with horizontal overflow scroll and mobile hamburger
- `MetricsGraph` - ReactFlow visualization with live connection edges reflecting health, database, MCP, and security status; accepts `metrics`, `health`, `mcpServers`, and `onNodeClick` props; clicking nodes navigates to existing detail views or the Security > System Details tab
- `TaskHistory` - Historical task browser
- `SecurityEvents` - Audit log viewer with heartbeat task section (auto-expandable via URL param)
- `ConnectionManager` - Platform integration UI
- `ChatPage` - Conversational AI interface

### 5. Soul System

**Location**: `packages/core/src/soul/`

**Responsibilities**:
- Personality management (create, switch, update active personality)
- Prompt composition following the "In Our Image" hierarchy (Soul > Spirit > Brain > Body > Heart)
- Sacred archetypes cosmological preamble
- User profile and owner context injection
- Skill management (delegated to Brain when available)

The active personality is the sole source of identity in the composed prompt. The agent name is stored separately for display purposes but is not injected into the system prompt — the personality's own `name` and `systemPrompt` fields define the complete identity.

**Key Modules**:
- `archetypes.ts` - Sacred archetypes constant and `composeArchetypesPreamble()`
- `storage.ts` - SQLite persistence for personalities, skills, users
- `manager.ts` - SoulManager with prompt composition orchestrating all four layers
- `soul-routes.ts` - REST API endpoints

### 6. Spirit System

**Location**: `packages/core/src/spirit/`

**Responsibilities**:
- Passion, inspiration, and pain point management
- Emotional prompt composition (`## Spirit` section)
- Sits between Soul (identity) and Brain (knowledge) in the hierarchy

**Key Modules**:
- `storage.ts` - SQLite persistence for passions, inspirations, pains
- `manager.ts` - SpiritManager with `composeSpiritPrompt()`
- `spirit-routes.ts` - REST API endpoints

### 7. Brain System

**Location**: `packages/core/src/brain/`

**Responsibilities**:
- Memory storage and retrieval (episodic, semantic, procedural, preference)
- Knowledge base management with confidence tracking
- Skill registry (moved from Soul for separation of concerns)
- Context injection into AI prompts (`## Brain` section) from relevant memories/knowledge

**Key Modules**:
- `storage.ts` - SQLite persistence for memories, knowledge, and skills
- `manager.ts` - BrainManager with memory decay, pruning, and context retrieval
- `brain-routes.ts` - REST API endpoints including knowledge CRUD (PUT/DELETE), heartbeat task management, and external brain sync
- `external-sync.ts` - ExternalBrainSync for exporting to Obsidian, Git Repo, or Filesystem

### 8. Body System

**Location**: `packages/core/src/body/`

**Responsibilities**:
- Physical form and capability management (vision, limb movement, auditory, haptic)
- Heart subsystem for vital signs and periodic self-checks
- Per-task heartbeat scheduling — each task has its own `intervalMs` so checks run at different frequencies
- Reflective tasks that record episodic memories for self-improvement
- Body prompt injection (`## Body` section with `### Heart` subsection) into the composed Soul prompt

**Key Modules**:
- `heart.ts` - HeartManager wrapping HeartbeatManager, owns `### Heart` prompt subsection including task schedule
- `heartbeat.ts` - HeartbeatManager with per-task scheduling, `updateTask()`, reflective task handler, and `lastRunAt` tracking

### 9. Agent Communication (Comms)

**Location**: `packages/core/src/comms/`

**Responsibilities**:
- E2E encrypted messaging between FRIDAY instances
- Peer agent discovery and management
- Secret sanitization (strips API keys, tokens from payloads)
- Local message log with retention policies

**Key Modules**:
- `crypto.ts` - X25519 key exchange + Ed25519 signing + AES-256-GCM encryption
- `storage.ts` - Peer registry and message log persistence
- `agent-comms.ts` - AgentComms orchestrator
- `comms-routes.ts` - REST API endpoints

### 10. Sandbox System

**Location**: `packages/core/src/sandbox/`

**Responsibilities**:
- Cross-platform execution isolation
- Resource limits and monitoring
- Filesystem access control
- Network restriction enforcement

**Features**:
- Platform-specific implementations:
  - **Linux**: V1 soft sandbox (path validation, resource tracking) + V2 Landlock kernel enforcement via forked worker process (graceful fallback to V1 if kernel lacks Landlock support)
  - **macOS**: `sandbox-exec` profile generation with deny-default policy; falls back to resource tracking when sandbox-exec is unavailable
  - **Other**: NoopSandbox fallback with warning
- Resource usage tracking (memory peak, CPU time)
- Violation detection and reporting
- SandboxManager auto-detects platform capabilities and selects the appropriate implementation

### 11. Integration Framework

**Location**: `packages/core/src/integrations/`

**Responsibilities**:
- Platform adapter lifecycle management (init, start, stop, health)
- Message normalization between platform-specific and unified formats
- Message routing from inbound messages to AI and back to platform

**Key Modules**:
- `manager.ts` - IntegrationManager with factory registration and lifecycle control
- `conversation.ts` - ConversationManager with per-platform context windows
- `types.ts` - Integration, PlatformAdapter, UnifiedMessage interfaces

**Platform Adapters**:
- `telegram/` - grammy bot API with long-polling
- `discord/` - discord.js v14 with slash commands and embeds
- `slack/` - Slack Bolt with socket mode
- `github/` - Octokit REST + webhook handler with signature verification

### 12. Logging & File Writer

**Location**: `packages/core/src/logging/`

**Responsibilities**:
- Structured JSON logging via Pino
- Append-only JSONL file output
- Log rotation with gzip compression
- Full-text search via FTS5

**Key Modules**:
- `sqlite-storage.ts` - SQLite audit storage with WAL mode and FTS5
- `file-writer.ts` - AppendOnlyLogWriter (JSONL, O_APPEND)
- `log-rotation.ts` - LogRotator (size/age-based, gzip compression)

### 13. Monitoring (Prometheus)

**Location**: `packages/core/src/gateway/prometheus.ts`

**Responsibilities**:
- `/metrics` endpoint in Prometheus text exposition format
- Task, resource, and security counter metrics
- Integration with Grafana dashboards and alert rules

**Deployment configs**: `deploy/prometheus/`, `deploy/grafana/`, `deploy/logging/`

---

## Security Architecture

### Defense in Depth

```
┌─────────────────────────────────────────────────────────┐
│                    Network Layer                        │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐        │
│  │   TLS 1.3   │ │ Domain WL   │ │ Rate Limit  │        │
│  └─────────────┘ └─────────────┘ └─────────────┘        │
└─────────────────────────┬───────────────────────────────┘
                          │
┌─────────────────────────┴───────────────────────────────┐
│                  Application Layer                      │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐        │
│  │     RBAC    │ │ Input Val   │ │   JWT Auth  │        │
│  └─────────────┘ └─────────────┘ └─────────────┘        │
└─────────────────────────┬───────────────────────────────┘
                          │
┌─────────────────────────┴───────────────────────────────┐
│                   Execution Layer                       │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐        │
│  │   Sandbox   │ │ Encryption  │ │   Audit     │        │
│  └─────────────┘ └─────────────┘ └─────────────┘        │
└─────────────────────────────────────────────────────────┘
```

### Security Features

| Layer | Mechanism | Purpose |
|-------|-----------|---------|
| **Network** | TLS 1.3, Domain Whitelisting | Secure communication, prevent unauthorized access |
| **Application** | RBAC, JWT, Input Validation | Access control, prevent injection attacks |
| **Execution** | Sandboxing, Encryption, Audit | Isolate untrusted code, protect data, track access |

---

## Data Flow

### Request Processing Flow

```
1. Client Request
   ↓
2. Gateway Authentication
   ↓ (JWT/API Key)
3. RBAC Authorization
   ↓ (Permission Check)
4. Input Validation
   ↓ (Sanitization)
5. Rate Limit Check
   ↓ (Sliding Window)
6. Task Creation
   ↓ (Queue)
7. Sandboxed Execution
   ↓ (Resource Limits)
8. AI Provider Call
   ↓ (Multi-provider)
9. Response Processing
   ↓ (Validation)
10. Audit Logging
    ↓ (Cryptographic Chain)
11. Client Response
```

### Audit Data Flow

```
Task Execution
   ↓
Event Capture (Structured Logger)
   ↓
Entry Creation (UUID v7 + Hash)
   ↓
Chain Verification (HMAC-SHA256)
   ↓
SQLite Storage (WAL Mode)
   ↓
Query API (REST Endpoint)
   ↓
Dashboard Display (WebSocket)
```

---

## Technology Stack

### Backend

| Component | Technology | Reason |
|-----------|------------|--------|
| Runtime | Node.js 20 LTS | TypeScript support, async performance |
| Framework | Fastify | High performance, built-in validation |
| Database | SQLite | Zero-config, portable, ACID compliant |
| Cryptography | Node.js crypto | Native implementation, FIPS compliant |
| Testing | Vitest | Fast, Vite-native, modern |

### Frontend

| Component | Technology | Reason |
|-----------|------------|--------|
| Framework | React 18 | Component ecosystem, concurrent features |
| Build Tool | Vite | Fast HMR, modern bundling |
| State Management | TanStack Query | Cache management, real-time updates |
| UI Components | Tailwind CSS | Utility-first, consistent |
| Visualization | ReactFlow | Interactive node graphs |
| TypeScript | TypeScript 5 | Type safety, developer experience |

### Development

| Tool | Purpose |
|------|---------|
| ESLint + Prettier | Code quality and formatting |
| Husky | Git hooks for pre-commit checks |
| GitHub Actions | CI/CD pipeline |
| Docker | Containerization and deployment |

---

## Design Decisions

### 1. Monorepo vs Multi-repo

**Decision**: Monorepo with npm workspaces

**Rationale**:
- Shared TypeScript types between packages
- Unified tooling and configuration
- Simplified dependency management
- Atomic commits across packages

### 2. Database Choice

**Decision**: SQLite with PostgreSQL abstraction

**Rationale**:
- SQLite: Zero-config, perfect for single-user local deployment
- PostgreSQL: Scalable for multi-user enterprise deployments
- Abstraction layer for flexibility

### 3. Authentication Strategy

**Decision**: JWT + API keys with refresh rotation

**Rationale**:
- JWT: Stateless, works well with distributed systems
- API Keys: Simple for programmatic access
- Refresh rotation: Balance security and usability

### 4. Real-time Communication

**Decision**: WebSocket with SSE fallback

**Rationale**:
- WebSocket: Full-duplex, low latency for real-time updates
- SSE: Simple fallback for firewall-restricted environments
- Both standardized and well-supported

### 5. Security Model

**Decision**: Defense in depth with audit first

**Rationale**:
- Multiple layers prevent single point of failure
- Comprehensive logging for compliance and forensics
- Security as a first-class citizen, not an afterthought

### 6. Plugin Architecture

**Decision**: TypeScript interfaces with dynamic imports

**Rationale**:
- Type-safe plugin development
- Runtime flexibility for integrations
- Sandboxed plugin execution

---

## Performance Considerations

### Scalability

| Component | Scaling Strategy |
|-----------|------------------|
| Gateway | Horizontal scaling with load balancer |
| Database | Read replicas, connection pooling |
| AI Calls | Provider rotation, caching, retry |
| Dashboard | Code splitting, lazy loading |

### Caching

| Layer | Cache Type | Duration |
|-------|------------|----------|
| API Response | In-memory | 5 minutes |
| AI Calls | Token cache | 1 hour |
| RBAC | Permission cache | 30 minutes |
| Audit Queries | SQLite WAL | Real-time |

### Monitoring

- Real-time metrics via WebSocket
- Prometheus export for observability
- Structured logging for debugging
- Performance profiling with built-in timers

---

## Related Documentation

- [API Reference](../api/)
- [Security Model](../security/security-model.md)
- [Development Roadmap](roadmap.md)

---

*This architecture document reflects the current state of F.R.I.D.A.Y. and evolves as the system develops.*